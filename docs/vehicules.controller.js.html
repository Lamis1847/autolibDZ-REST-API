<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: vehicules.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: vehicules.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const db = require('../models');
const Vehicule = db.vehicules;

const cloudinary = require('cloudinary').v2;
require('dotenv').config();

// cloudinary configuration
cloudinary.config({
	cloud_name: process.env.CLOUD_NAME,
	api_key: process.env.API_KEY,
	api_secret: process.env.API_SECRET,
});

/**
 * Create and save a new Vehicule in database
 * @param {*} req The request
 * @param {*} res The response
 */
// Create and Save a new Vehicule

const createVehicule = async (req, res) => {
	// Validate request
	if (
		!req.body.numChassis ||
		!req.body.numImmatriculation ||
		!req.body.modele ||
		!req.body.marque ||
		!req.body.couleur ||
		!req.body.etat
	) {
		res.status(400).send({
			message: 'Content can not be empty!',
		});
		console.log(req.body.numChassis);
		console.log(req.body.numImmatriculation);
		console.log(req.body.modele);
		console.log(req.body.couleur);
		return;
	}
	// Create a Vehicule
	const vehicule = {
		numChassis: req.body.numChassis,
		numImmatriculation: req.body.numImmatriculation,
		modele: req.body.modele,
		marque: req.body.marque,
		couleur: req.body.couleur,
		etat: req.body.etat,
		tempsDeRefroidissement: req.body.tempsDeRefroidissement,
		pressionHuileMoteur: req.body.pressionHuileMoteur,
		chargeBatterie: req.body.chargeBatterie,
		anomalieCircuit: req.body.anomalieCircuit,
		pressionPneus: req.body.pressionPneus,
		niveauMinimumHuile: req.body.niveauMinimumHuile,
		regulateurVitesse: req.body.regulateurVitesse,
		limiteurVitesse: req.body.limiteurVitesse,
		idAgentMaintenance: req.body.idAgentMaintenance,
		idBorne: req.body.idBorne,
		idCloudinary: '',
		secureUrl: '',
	};

	// upload image to cloudinary here
	if (req.body.image) {
		const image = req.body.image;
		try {
			ress = await cloudinary.uploader.upload(req.body.image).then((result) => {
				vehicule.idCloudinary = result.public_id;
				vehicule.secureUrl = result.secure_url;
			});
		} catch (error) {
			console.log(error);
		}
	}

	// Add data to databse
	try {
		let result = await Vehicule.findAll({
			where: {
				numChassis: req.body.numChassis,
			},
		});
		if (result.length > 0) {
			res.status(400).send({
				message: 'Vehicule already exists!',
			});
		} else {
			let data;
			data = await Vehicule.create(vehicule).then((data) => {
				res.send(data);
			});
		}
	} catch (err) {
		res.status(500).send({
			error: err.message || 'Some error occurred while creating the Vehicule.',
		});
	}
};

/**
 * Delete a vehicule with the specified ID in request body
 * @param {*} req The request
 * @param {*} res The response
 */
//Delete vehicule with numChassis = id

const deleteVehicule = async (req, res) => {
	const id = req.params.id;

	console.log(id);

	Vehicule.destroy({
		where: { numChassis: id },
	})
		.then((num) => {
			if (num == 1) {
				res.send({
					message: 'Vehicule was deleted successfully!',
				});
			} else {
				res.send({
					message: `Cannot delete Vehicule with id=${id}. Maybe Vehicule was not found!`,
				});
			}
		})
		.catch((err) => {
			res.status(500).send({
				message: 'Could not delete Vehicule with id=' + id,
			});
		});
};

/**
 * Update a Vehicule that has the specified ID in request body with data in request body
 * @param {*} req The request
 * @param {*} res The response
 */
//Update vehicule with numChassis = id
const updateVehicule = async (req, res) => {
	const id = req.params.id;

	Vehicule.update(req.body, {
		where: { numChassis: id },
	})
		.then((num) => {
			if (num == 1) {
				res.send({
					message: 'Vehicule was updated successfully.',
				});
			} else {
				res.send({
					message: `Cannot update Vehicule with id=${id}. Maybe Vehicule was not found or req.body is empty!`,
				});
			}
		})
		.catch((err) => {
			res.status(500).send({
				message: 'Error updating Vehicule with id=' + id,
			});
		});
};

/**
 * Return details of all vehicules thar are stored in database
 * @param {*} req request
 * @param {*} res response
 */

const getAllVehicule = async (req, res) => {
	Vehicule.findAll()
		.then((data) => {
			res.send(data);
		})
		.catch((err) => {
			res.status(500).send({
				message: 'Error retrieving Vehicule with id=' + id,
			});
		});
};

/**
 * This function displays the details of a given car, identified by it's num chassis
 * return 404 status with not_found error as json if it doesn't exist
 * return 200 status with the actual car oin json if it exists
 *
 * @param {*} req The request of the client
 * @param {*} res The response from the server
 * @param {*} next Used to move on to the next middleware
 */

const getVehiculeDetails = async (req, res, next) => {
	try {
		if (parseInt(req.params.numChassis, 10)) {
			const vehicule = await Vehicule.findAll({
				where: {
					numChassis: +req.params.numChassis,
				},
			});
			if (vehicule.length === 0) {
				// No content with that numChassis
				res.status(404).send({
					error: 'not_found',
					message: `No vehicule with such numero chassis: ${+req.params
						.numChassis}`,
					status: 404,
				});
			} else {
				res.status(200).send(vehicule[0]);
			}
		} else next();
	} catch (err) {
		res.status(500).send({
			error:
				err.message || 'Some error occured while retreiving vehicule,s details',
		});
	}
};

/**
 * This function returns all vehicules of a given agent de maintenace, identified by it's id
 * returns 404 status with not-found error message if nothing is found
 * returns 200 status with the actuals cars if the car(s) exist(s)
 *
 * @param {*} req The client request
 * @param {*} res The server response
 * @param {*} done Used to move on into the next middleware
 */

const selectVehicuesOfAGivenAgent = async (req, res, done) => {
	try {
		if (parseInt(req.params.id, 10)) {
			const vehicules = await Vehicule.findAll({
				where: {
					idAgentMaintenance: +req.params.id,
				},
			});
			if (vehicules.length === 0) {
				// No content with that id
				res.status(404).send({
					error: 'not_found',
					message: `No content with such id: ${+req.params.id}`,
					status: 404,
				});
			} else {
				res.status(200).send(vehicules);
			}
			res.status(200).send(vehicules);
		} else done();
	} catch (err) {
		res.status(500).send({
			error:
				err.message ||
				'Some error occured while retreiving vehicules agent id: ' +
					req.params.id,
		});
	}
};

/**
 * This function gets fired on a PUT request to /api/vehicules/etat/:numChassis
 * the request should have an attribute 'etat' set to either 'en-service' or 'hors-service', no other values are accepted
 * returns a 404 status with not-found error message if the num chasiis given doesn't exist
 * returns an object {Updated rows, UpdatedVehicule} contained numer of rows affected (modified) and the actual cars which have been affected
 *
 * @param {*} req The client requeest
 * @param {*} res The server response
 */
const setEtatVehicule = async (req, res) => {
	try {
		let state = req.body.etat;
		if (state) {
			state = state.toLowerCase();
			if (state === 'en service' || state === 'hors service') {
				const response = await Vehicule.update(
					{ etat: state },
					{
						returning: true,
						where: {
							numChassis: +req.params.numChassis,
						},
					}
				);

				const UpdatedRows = response[0];
				const UpdatedVehicule = response[1];

				if (UpdatedVehicule.length === 0) {
					// No content with that numChassis
					res.status(404).send({
						error: 'not_found',
						message: `No vehicule with such numero chassis: ${+req.params
							.numChassis}`,
						status: 404,
					});
				} else {
					res.status(200).send({ UpdatedRows, UpdatedVehicule });
				}
			} else {
				res.status(400).send({
					message:
						"Attribute 'etat' must be either 'en service' or 'hors service'",
				});
				return;
			}
		} else {
			res.status(400).send({
				message: "params 'etat' can not be empty!",
			});
			return;
		}
	} catch (err) {
		res.status(500).send({
			error:
				err.message ||
				'Some error occured while attemping to set state of vehicule id ' +
					req.params.numChassis,
		});
	}
};

/**
 * returns all 'en-service' cars of a given agent de maintenace, identified by id
 * returns 404 status with not-found error message if no id is found
 * return 200 status with all the concerned cars in form of json
 *
 * @param {*} req The client request
 * @param {*} res The server response
 */

const getVehiculesEnServiceOfAGivenAgent = async (req, res) => {
	try {
		const vehiculesEnService = await Vehicule.findAll({
			where: {
				etat: 'en service',
				idAgentMaintenance: +req.params.id,
			},
		});
		if (vehiculesEnService.length === 0) {
			// No content
			res.status(404).send({
				error: 'not_found',
				message: `No vehicules are 'en service'`,
				status: 404,
			});
		} else {
			res.status(200).send(vehiculesEnService);
		}
	} catch (err) {
		res.status(500).send({
			error:
				err.message ||
				"Some error occured while retreiving vehicules 'en service'",
		});
	}
};

/**
 * This function returns all 'hors-service' cars of a given aget de maintenace, identified by it's id
 * returns 404 status with not-found error message if no such id exist
 * returns 200 status with all the concerned cars in form of json
 *
 * @param {*} req The client request
 * @param {*} res The server response
 */

const getVehiculesHorsServiceOfAGivenAgent = async (req, res) => {
	try {
		const vehiculesHorsService = await Vehicule.findAll({
			where: {
				etat: 'hors service',
				idAgentMaintenance: +req.params.id,
			},
		});
		if (vehiculesHorsService.length === 0) {
			// No content
			res.status(404).send({
				error: 'not_found',
				message: `No vehicules are 'hors service'`,
				status: 404,
			});
		} else {
			res.status(200).send(vehiculesHorsService);
		}
	} catch (err) {
		res.status(500).send({
			error:
				err.message ||
				"Some error occured while retreiving vehicules 'hors service'",
		});
	}
};

export default {
	setEtatVehicule,
	getVehiculeDetails,
	selectVehicuesOfAGivenAgent,
	getVehiculesEnServiceOfAGivenAgent,
	getVehiculesHorsServiceOfAGivenAgent,

	createVehicule,
	deleteVehicule,
	updateVehicule,
	getAllVehicule,
	//getVehiculeByCondition
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#createVehicule">createVehicule</a></li><li><a href="global.html#deleteVehicule">deleteVehicule</a></li><li><a href="global.html#getAllVehicule">getAllVehicule</a></li><li><a href="global.html#getVehiculeDetails">getVehiculeDetails</a></li><li><a href="global.html#getVehiculesEnServiceOfAGivenAgent">getVehiculesEnServiceOfAGivenAgent</a></li><li><a href="global.html#getVehiculesHorsServiceOfAGivenAgent">getVehiculesHorsServiceOfAGivenAgent</a></li><li><a href="global.html#selectVehicuesOfAGivenAgent">selectVehicuesOfAGivenAgent</a></li><li><a href="global.html#setEtatVehicule">setEtatVehicule</a></li><li><a href="global.html#updateVehicule">updateVehicule</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Tue May 25 2021 23:01:15 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
